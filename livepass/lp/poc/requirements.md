# Livepass-LP 技術要件定義書

## 1. システム概要

### 1.1 プロダクト概要
LP（ランディングページ）上でユーザーの行動データから「迷い」や「詰まり」を検知し、適切なタイミングでアシストUI（チャット、動画、選択肢など）を表示するシステム。

### 1.2 システム構成
```
[埋め込みJS] → [CloudFront] → [API Gateway] → [Lambda]
                                                    ↓
                                               [RDS(PostgreSQL)]
                                                    ↓
                                               [AWS Bedrock Claude]
```

## 2. アーキテクチャ設計

### 2.1 フロントエンド（埋め込みスクリプト）

#### 技術選定
- **フレームワーク**: Next.js（埋め込みスクリプト生成）
- **言語**: TypeScript
- **ビルド**: Webpack（最小化・難読化）
- **配信**: S3 + CloudFront CDN
- **サイズ目標**: 50KB以下（gzip圧縮後）

#### 管理画面ホスティング
- **フレームワーク**: Next.js
- **ホスティング**: S3 + CloudFront
- **用途**: クライアント企業ごとのカスタマイズ設定
- **主要機能**: 
  - トリガー条件設定
  - アシストUI表示設定
  - 効果測定ダッシュボード

#### 埋め込み方法
```html
<!-- クライアント企業のLPに埋め込むタグ -->
<script src="https://cdn.livepass-lp.com/v1/assist.min.js"></script>
<script>
  LivepassLP.init({
    apiKey: 'your-api-key',
    companyId: 'your-company-id'
  });
</script>
```

#### 主要機能
- ユーザー行動トラッキング（マウス、スクロール、クリック）
- DOM解析とコンテンツ理解
- トリガー条件の検知
- アシストUI表示制御
- APIとの通信

### 2.2 バックエンド

#### 技術スタック
- **言語**: TypeScript（Lambda直接実装）
- **実行環境**: AWS Lambda（サーバーレス）
- **ORM**: Prisma
- **データベース**: RDS PostgreSQL
- **LLM**: AWS Bedrock Claude
- **APIゲートウェイ**: AWS API Gateway

#### Lambda選定理由
1. **コスト効率**：使用時のみ課金
2. **自動スケーリング**：トラフィック変動に対応
3. **運用負荷軽減**：サーバー管理不要
4. **高可用性**：AWSマネージドサービス

#### 主要機能
- 行動データの収集・解析
- LLMとの連携（問いかけ生成）
- 企業別設定の管理
- アシスト効果の計測

### 2.3 データストア

#### RDS（PostgreSQL）
- クライアント企業ごとのカスタマイズ情報が必要になった場合に実装
- 詳細設計は必要に応じて決定

### 2.4 企業別設定管理

#### 設定可能項目（予定）
- **トリガー条件**
  - ホバー時間の閾値
  - スクロール停止判定
  - 無操作時間の定義
  
- **UI表示設定**
  - 表示位置（右下、左下など）
  - アニメーション種類
  - カラーテーマ
  
- **コンテンツ設定**
  - 問いかけテンプレート
  - 動画ID/URLマッピング
  - カスタムメッセージ

## 3. データフロー

### 3.1 初期化フロー
1. 埋め込みスクリプトロード
2. 企業設定を取得（API経由）
3. DOM解析・ページ情報収集
4. トラッキング開始

### 3.2 アシスト表示フロー
1. ユーザー行動検知
2. トリガー条件判定
3. コンテキスト情報収集
4. LLM問い合わせ（必要時）
5. アシストUI表示
4. ユーザー反応記録

### 3.3 LLM連携フロー
```
[行動データ] → [コンテキスト生成] → [キャッシュ確認]
                                          ↓
                                    [キャッシュヒット] → [即座返答]
                                          ↓
                                    [キャッシュミス] → [LLM API] → [キャッシュ保存]
```


## 4. 開発・運用環境

### 4.1 開発環境
- **言語**: TypeScript
- **テスト**: Jest
- **CI/CD**: GitHub Actions
- **環境**: Development/Staging/Production

### 4.2 モニタリング
- **APM**: AWS X-Ray
- **ログ**: CloudWatch Logs
- **アラート**: CloudWatch Alarms
- **分析**: カスタムダッシュボード

### 4.3 デプロイメント
- **IaC**: AWS CDK or Terraform
- **コンテナ**: なし（Lambda直接デプロイ）
- **CDN**: CloudFront自動無効化

## 5. PoC実施アプローチ

### Phase 1: 基本機能検証
- スクロール検知の精度検証
- 基本的なトリガー実装（3パターン）
- 固定文言でのアシスト表示

### Phase 2: 高度な機能実装
- クライアント情報統合
- ページ遷移対応の検証
- スマホ/PC両対応確認
- Google Audience Triggerの検証（リアルタイム性の確認）

### Phase 3: 本番環境検証
- 実LP環境での効果測定
- CVR改善率の検証
- 企業別設定機能の実装
